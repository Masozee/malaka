version: '3.8'

services:
  # Exchange Rate Scheduler Service
  exchange-rate-scheduler:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: malaka-exchange-rates
    restart: unless-stopped
    environment:
      - DB_HOST=malaka-db
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=TanahAbang1971
      - DB_NAME=malaka
      - TZ=Asia/Jakarta
    volumes:
      - ./backend:/app
    command: >
      sh -c "
        echo 'Starting Exchange Rate Scheduler...' &&
        go run cmd/exchange-rates/main.go -start
      "
    depends_on:
      - malaka-db
    networks:
      - malaka-network

  # One-time Exchange Rate Fetcher (for manual runs)
  exchange-rate-fetcher:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: malaka-exchange-rates-fetch
    environment:
      - DB_HOST=malaka-db
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=TanahAbang1971
      - DB_NAME=malaka
      - TZ=Asia/Jakarta
    volumes:
      - ./backend:/app
    command: >
      sh -c "
        echo 'Fetching Exchange Rates...' &&
        go run cmd/exchange-rates/main.go -fetch
      "
    depends_on:
      - malaka-db
    networks:
      - malaka-network
    profiles:
      - manual # Only run when explicitly requested

networks:
  malaka-network:
    external: true

volumes:
  postgres_data: